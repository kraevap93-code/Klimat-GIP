<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #27272a;
            --card-bg-color: #3f3f46;
            --text-primary: #f4f4f5;
            --text-secondary: #a1a1aa;
            --input-bg: #27272a;
            --border-color: #52525b;
            --header-bg: #27272a;
            --table-header-bg: #3f3f46;
            --hover-bg: #52525b;
            --date-header-bg: #52525b;
            --problem-bg: rgba(239, 68, 68, 0.1);
            --problem-hover-bg: rgba(239, 68, 68, 0.2);
            --active-tab-bg: #FFC700;
            --active-tab-text: #1E1E1E;
            --inactive-tab-bg: #3f3f46;
            --inactive-tab-text: #f4f4f5;
        }

        html.light {
            --bg-color: #f9fafb;
            --card-bg-color: #ffffff;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --input-bg: #ffffff;
            --border-color: #d1d5db;
            --header-bg: #f9fafb;
            --table-header-bg: #f3f4f6;
            --hover-bg: #f3f4f6;
            --date-header-bg: #e5e7eb;
            --problem-bg: rgba(239, 68, 68, 0.1);
            --problem-hover-bg: rgba(239, 68, 68, 0.2);
            --active-tab-bg: #FFC700;
            --active-tab-text: #1E1E1E;
            --inactive-tab-bg: #e5e7eb;
            --inactive-tab-text: #111827;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        .card {
            background-color: var(--card-bg-color);
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            transition: background-color 0.3s;
        }
        .form-input, .form-select, .form-textarea {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #FFC700;
            box-shadow: 0 0 0 2px rgba(255, 199, 0, 0.5);
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1rem;
            border: 1px solid transparent;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            font-size: 1rem;
            font-weight: 600;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .btn-submit {
            color: #1E1E1E;
            background-color: #FFC700;
        }
        .btn-submit:hover {
            background-color: #e6b300;
        }
        .btn-secondary {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        .btn-secondary:hover {
            background-color: var(--hover-bg);
        }
        .table-header {
            background-color: var(--table-header-bg);
        }
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex; align-items: center; justify-content: center; z-index: 50;
            transition: opacity 0.3s ease;
        }
        .slider-checkbox:checked ~ .slider-bg { background-color: #FFC700; }
        html.light .slider-checkbox:checked ~ .slider-bg { background-color: #FFC700; }
        .slider-checkbox:checked ~ .slider-dot { transform: translateX(100%); }
        
        /* Air Quality Status Dots */
        .status-dot {
            display: inline-block; width: 10px; height: 10px; border-radius: 50%;
            margin-right: 8px; vertical-align: middle;
        }
        .status-good { background-color: #3CFF00; }
        .status-moderate { background-color: #FFE500; }
        .status-bad { background-color: #FF0000; }

        /* Navigation Tabs */
        .nav-tab {
            padding: 0.5rem 1.5rem;
            font-weight: 600;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: var(--inactive-tab-bg);
            color: var(--inactive-tab-text);
            border: 2px solid transparent;
        }
        .nav-tab.active {
            background-color: var(--active-tab-bg);
            color: var(--active-tab-text);
        }
        .nav-tab:not(.active):hover {
            background-color: var(--hover-bg);
            border-color: var(--border-color);
        }
        .scrollable-table {
            max-height: 60vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Auth Container -->
    <div id="auth-container" class="max-w-md mx-auto">
        <div class="card">
            <div id="login-view">
                <h2 class="text-2xl font-bold text-center mb-6">–í—Ö–æ–¥ –≤ –ü–∞–Ω–µ–ª—å –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</h2>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-secondary">Email</label>
                        <input type="email" id="login-email" class="mt-1 form-input" required>
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-secondary">–ü–∞—Ä–æ–ª—å</label>
                        <input type="password" id="login-password" class="mt-1 form-input" required>
                    </div>
                    <p id="login-error" class="text-red-500 text-sm hidden"></p>
                    <button type="submit" class="btn btn-submit w-full">–í–æ–π—Ç–∏</button>
                </form>
                <p class="mt-4 text-center text-sm text-secondary">
                    –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#" id="show-register" class="font-medium text-[#FFC700] hover:underline">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
                </p>
            </div>
            <div id="register-view" class="hidden">
                <h2 class="text-2xl font-bold text-center mb-6">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
                <form id="register-form" class="space-y-4">
                    <div>
                        <label for="register-email" class="block text-sm font-medium text-secondary">Email</label>
                        <input type="email" id="register-email" class="mt-1 form-input" required>
                    </div>
                    <div>
                        <label for="register-password" class="block text-sm font-medium text-secondary">–ü–∞—Ä–æ–ª—å</label>
                        <input type="password" id="register-password" class="mt-1 form-input" required>
                    </div>
                    <p id="register-error" class="text-red-500 text-sm hidden"></p>
                    <button type="submit" class="btn btn-submit w-full">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
                </form>
                <p class="mt-4 text-center text-sm text-secondary">
                    –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="#" id="show-login" class="font-medium text-[#FFC700] hover:underline">–í–æ–π—Ç–∏</a>
                </p>
            </div>
        </div>
    </div>

    <!-- App Container -->
    <div id="app-container" class="max-w-screen-2xl mx-auto hidden">
        <header class="mb-8">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <div>
                    <p class="text-sm text-secondary">–í—ã –≤–æ—à–ª–∏ –∫–∞–∫:</p>
                    <p id="user-email" class="text-lg font-bold"></p>
                    <button id="logout-btn" class="text-sm text-red-500 hover:underline">–í—ã–π—Ç–∏</button>
                </div>
                 <div class="flex items-center gap-4">
                    <button id="history-btn" class="hidden btn btn-secondary w-auto px-4 py-2 text-sm rounded-md">–û–±—â–∞—è –∏—Å—Ç–æ—Ä–∏—è –ö–ª–∏–º–∞—Ç</button>
                    <label class="flex items-center cursor-pointer">
                        <div class="relative">
                            <input type="checkbox" id="theme-toggle" class="sr-only slider-checkbox">
                            <div class="block w-14 h-8 rounded-full slider-bg" style="background-color: var(--border-color);"></div>
                            <div class="dot absolute left-1 top-1 w-6 h-6 rounded-full transition-transform slider-dot" style="background-color: var(--card-bg-color);"></div>
                        </div>
                    </label>
                </div>
            </div>
            <div class="flex justify-center items-center gap-4 p-2 rounded-lg" style="background-color: var(--card-bg-color);">
                <button id="tab-klimat" data-view="klimat-view" class="nav-tab active">üìä –ö–ª–∏–º–∞—Ç</button>
                <button id="tab-vozduh" data-view="vozduh-view" class="nav-tab">üå¨Ô∏è –ö–∞—á–µ—Å—Ç–≤–æ –≤–æ–∑–¥—É—Ö–∞</button>
            </div>
        </header>

        <!-- VIEWS CONTAINER -->
        <main>
            <!-- Klimat View -->
            <div id="klimat-view">
                <div class="card">
                    <h2 class="text-2xl font-semibold mb-6">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å</h2>
                    <form id="add-klimat-form" class="space-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="klimat-date" class="block text-sm font-medium text-secondary">–î–∞—Ç–∞</label>
                                <input type="date" id="klimat-date" class="mt-1 form-input" required>
                            </div>
                            <div>
                                <label for="klimat-time" class="block text-sm font-medium text-secondary">–í—Ä–µ–º—è</label>
                                <input type="time" id="klimat-time" class="mt-1 form-input" required>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-md font-semibold text-primary mb-2">–ö–ª–∏–º–∞—Ç –≤ –ø–æ–º–µ—â–µ–Ω–∏–∏</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                <div><label for="temp" class="block text-sm font-medium text-secondary">–¢–µ–º–ø. (¬∞–°)</label><input type="number" step="0.001" id="temp" class="mt-1 form-input" required></div>
                                <div><label for="humidity" class="block text-sm font-medium text-secondary">–í–ª–∞–∂–Ω. (%)</label><input type="number" step="0.001" id="humidity" class="mt-1 form-input" required></div>
                                <div><label for="pressure" class="block text-sm font-medium text-secondary">–î–∞–≤–ª. (–º–º)</label><input type="number" step="0.001" id="pressure" class="mt-1 form-input" required></div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-md font-semibold text-primary mb-2">–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ GIP</h3>
                            <div class="grid grid-cols-2 sm:grid-cols-5 gap-4">
                                <div><label for="cyan" class="block text-sm font-medium text-secondary">Cyan</label><input type="number" step="0.001" id="cyan" class="mt-1 form-input" required></div>
                                <div><label for="magenta" class="block text-sm font-medium text-secondary">Magenta</label><input type="number" step="0.001" id="magenta" class="mt-1 form-input" required></div>
                                <div><label for="yellow" class="block text-sm font-medium text-secondary">Yellow</label><input type="number" step="0.001" id="yellow" class="mt-1 form-input" required></div>
                                <div><label for="black" class="block text-sm font-medium text-secondary">Black</label><input type="number" step="0.001" id="black" class="mt-1 form-input" required></div>
                                <div><label for="white" class="block text-sm font-medium text-secondary">White</label><input type="number" step="0.001" id="white" class="mt-1 form-input" required></div>
                            </div>
                        </div>
                        <div>
                            <label for="klimat-comment" class="block text-sm font-medium text-secondary">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                            <select id="klimat-comment" class="mt-1 form-select">
                                <option value="–ü—Ä–æ—Å—Ç—Ä–µ–ª–æ–≤, –ø–æ–ª–æ—Å –Ω–µ—Ç">–ü—Ä–æ—Å—Ç—Ä–µ–ª–æ–≤, –ø–æ–ª–æ—Å –Ω–µ—Ç</option>
                                <option value="other">–î—Ä—É–≥–æ–µ (–≤–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é)</option>
                            </select>
                            <div id="klimat-custom-comment-wrapper" class="hidden mt-2">
                                <input type="text" id="klimat-custom-comment" class="mt-1 form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-submit w-full mt-4">–î–æ–±–∞–≤–∏—Ç—å</button>
                    </form>
                </div>
                <div class="card mt-8">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                        <h2 class="text-2xl font-semibold">–ñ—É—Ä–Ω–∞–ª –¥–∞–Ω–Ω—ã—Ö –ö–ª–∏–º–∞—Ç</h2>
                        <div class="flex items-center gap-2">
                            <input type="date" id="search-date" class="form-input w-auto text-sm">
                            <button id="search-btn" class="btn btn-submit w-auto px-4 py-2 text-sm rounded-md">–ù–∞–π—Ç–∏</button>
                            <button id="reset-btn" class="btn btn-secondary w-auto px-4 py-2 text-sm rounded-md">–°–±—Ä–æ—Å–∏—Ç—å</button>
                        </div>
                    </div>
                    <div id="klimat-loading" class="text-center text-secondary py-8">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
                    <div class="overflow-x-auto hidden scrollable-table" id="klimat-table-container">
                        <table class="min-w-full divide-y" style="border-color: var(--border-color);">
                            <thead class="table-header">
                                <tr>
                                    <th rowspan="2" class="px-6 py-3 text-center align-middle text-xs font-medium text-secondary uppercase tracking-wider">–í—Ä–µ–º—è</th>
                                    <th colspan="3" class="px-6 py-3 text-center text-xs font-medium text-secondary uppercase tracking-wider border-b border-l" style="border-color: var(--border-color);">–ö–ª–∏–º–∞—Ç</th>
                                    <th colspan="5" class="px-6 py-3 text-center text-xs font-medium text-secondary uppercase tracking-wider border-b border-l" style="border-color: var(--border-color);">–î–∞–≤–ª–µ–Ω–∏–µ GIP</th>
                                    <th rowspan="2" class="px-6 py-3 text-center align-middle text-xs font-medium text-secondary uppercase tracking-wider border-l" style="border-color: var(--border-color);">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                                    <th rowspan="2" class="px-6 py-3 text-center align-middle text-xs font-medium text-secondary uppercase tracking-wider border-l" style="border-color: var(--border-color);">–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                                <tr>
                                    <th class="px-6 py-3 text-center align-middle text-xs font-medium text-secondary uppercase tracking-wider border-l" style="border-color: var(--border-color);">–¢–µ–º–ø.</th>
                                    <th class="px-6 py-3 text-center align-middle text-xs font-medium text-secondary uppercase tracking-wider">–í–ª–∞–∂.</th>
                                    <th class="px-6 py-3 text-center align-middle text-xs font-medium text-secondary uppercase tracking-wider">–î–∞–≤–ª.</th>
                                    <th class="px-6 py-3 text-center align-middle text-xs font-medium text-secondary uppercase tracking-wider border-l" style="border-color: var(--border-color);">Cyan</th>
                                    <th class="px-6 py-3 text-center align-middle text-xs font-medium text-secondary uppercase tracking-wider">Magenta</th>
                                    <th class="px-6 py-3 text-center align-middle text-xs font-medium text-secondary uppercase tracking-wider">Yellow</th>
                                    <th class="px-6 py-3 text-center align-middle text-xs font-medium text-secondary uppercase tracking-wider">Black</th>
                                    <th class="px-6 py-3 text-center align-middle text-xs font-medium text-secondary uppercase tracking-wider">White</th>
                                </tr>
                            </thead>
                            <tbody id="klimat-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Air Quality View -->
            <div id="vozduh-view" class="hidden">
                 <div class="card">
                    <h2 class="text-2xl font-semibold mb-6">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å</h2>
                    <form id="add-vozduh-form" class="space-y-4">
                         <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="vozduh-date" class="block text-sm font-medium text-secondary">–î–∞—Ç–∞</label>
                                <input type="date" id="vozduh-date" class="mt-1 form-input" required>
                            </div>
                            <div>
                                <label for="vozduh-time" class="block text-sm font-medium text-secondary">–í—Ä–µ–º—è</label>
                                <input type="time" id="vozduh-time" class="mt-1 form-input" required>
                            </div>
                        </div>
                        <div class="mt-4 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                            <div><label for="hcho" class="block text-sm font-medium text-secondary">HCHO</label><input type="number" step="0.001" id="hcho" class="mt-1 form-input" placeholder="0.010" required></div>
                            <div><label for="tvoc" class="block text-sm font-medium text-secondary">TVOC</label><input type="number" step="0.001" id="tvoc" class="mt-1 form-input" placeholder="0.08" required></div>
                            <div><label for="pm25" class="block text-sm font-medium text-secondary">PM2.5</label><input type="number" step="0.001" id="pm25" class="mt-1 form-input" placeholder="5.0" required></div>
                            <div><label for="pm10" class="block text-sm font-medium text-secondary">PM10</label><input type="number" step="0.001" id="pm10" class="mt-1 form-input" placeholder="8.0" required></div>
                            <div><label for="co2" class="block text-sm font-medium text-secondary">CO2</label><input type="number" step="0.001" id="co2" class="mt-1 form-input" placeholder="450" required></div>
                        </div>
                        <div>
                            <label for="vozduh-comment" class="block text-sm font-medium text-secondary">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                            <textarea id="vozduh-comment" rows="2" class="mt-1 form-textarea" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-submit w-full mt-4">–î–æ–±–∞–≤–∏—Ç—å</button>
                    </form>
                </div>
                 <div class="card mt-8">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                        <h2 class="text-2xl font-semibold">–ñ—É—Ä–Ω–∞–ª –∫–∞—á–µ—Å—Ç–≤–∞ –≤–æ–∑–¥—É—Ö–∞</h2>
                        <div class="flex items-center gap-2">
                            <input type="date" id="vozduh-search-date" class="form-input w-auto text-sm">
                            <button id="vozduh-search-btn" class="btn btn-submit w-auto px-4 py-2 text-sm rounded-md">–ù–∞–π—Ç–∏</button>
                            <button id="vozduh-reset-btn" class="btn btn-secondary w-auto px-4 py-2 text-sm rounded-md">–°–±—Ä–æ—Å–∏—Ç—å</button>
                        </div>
                    </div>
                    <div id="vozduh-loading" class="text-center text-secondary py-8">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
                    <div id="vozduh-table-container" class="overflow-x-auto hidden scrollable-table">
                        <table class="min-w-full divide-y" style="border-color: var(--border-color);">
                            <thead class="table-header">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">–í—Ä–µ–º—è</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">HCHO (–º–≥/–º¬≥)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">TVOC (–º–≥/–º¬≥)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">PM2.5 (–º–∫–≥/–º¬≥)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">PM10 (–º–∫–≥/–º¬≥)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">CO2 (ppm)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="vozduh-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Generic History View -->
            <div id="history-view" class="hidden">
                 <div class="card">
                    <div class="flex justify-between items-center mb-6">
                        <h2 id="history-title" class="text-2xl font-semibold">–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π</h2>
                        <button id="back-btn" class="btn btn-secondary px-4 py-2 text-sm w-auto">–ù–∞–∑–∞–¥</button>
                    </div>
                    <div class="overflow-x-auto scrollable-table">
                        <table class="min-w-full divide-y" style="border-color: var(--border-color);">
                            <thead class="table-header">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">–î–∞—Ç–∞</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">–î–µ–π—Å—Ç–≤–∏–µ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">–î–µ—Ç–∞–ª–∏</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="confirm-modal" class="modal-overlay hidden">
        <div class="card w-full max-w-sm">
            <h2 class="text-xl font-semibold mb-4" id="confirm-modal-title">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ</h2>
            <p id="confirm-modal-text" class="text-secondary mb-6">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.</p>
            <div class="flex justify-end gap-4">
                <button type="button" id="confirm-cancel-btn" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" id="confirm-delete-btn" class="btn bg-red-600 hover:bg-red-700 text-white">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="modal-overlay hidden">
        <div class="card w-full max-w-lg">
            <h2 class="text-xl font-semibold mb-4" id="edit-modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å</h2>
            <form id="edit-form" class="space-y-4 max-h-[70vh] overflow-y-auto pr-4">
                <!-- Dynamic content will be injected here by JavaScript -->
            </form>
            <div class="flex justify-end gap-4 mt-6">
                <button type="button" id="edit-cancel-btn" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" form="edit-form" id="edit-save-btn" class="btn btn-submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>


    <script type="module">
        // --- Firebase Initialization ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, getDocs, doc, getDoc, updateDoc, deleteDoc, orderBy, Timestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            
            // --- Firebase Configuration ---
            const firebaseConfig = {
                apiKey: "AIzaSyAfGrhtzScHVYMb4Li1muz56jzZdbBz6Ac",
                authDomain: "klimat-gip.firebaseapp.com",
                projectId: "klimat-gip",
                storageBucket: "klimat-gip.appspot.com",
                messagingSenderId: "369527961205",
                appId: "1:369527961205:web:8c57ab4e68725832e8b625"
            };
            
            // --- Initialize Firebase ---
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            const appId = firebaseConfig.projectId;

            // --- App State ---
            const ADMIN_EMAIL = 'lequangduc19865@gmail.com';
            let currentUserEmail = null;
            let unsubscribeKlimat, unsubscribeKlimatHistory, unsubscribeVozduh, unsubscribeVozduhHistory;
            let allKlimatEntries = [];
            let allVozduhRecords = [];
            let itemToDeleteContext = { id: null, type: null };
            let itemToEditContext = { id: null, type: null, data: null };
            let lastActiveTabId = 'tab-klimat';

            // --- UI Elements ---
            const authContainer = document.getElementById('auth-container');
            const appContainer = document.getElementById('app-container');
            const loginView = document.getElementById('login-view');
            const registerView = document.getElementById('register-view');
            const showRegisterBtn = document.getElementById('show-register');
            const showLoginBtn = document.getElementById('show-login');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const logoutBtn = document.getElementById('logout-btn');
            const userEmailEl = document.getElementById('user-email');
            const loginError = document.getElementById('login-error');
            const registerError = document.getElementById('register-error');
            const klimatView = document.getElementById('klimat-view');
            const vozduhView = document.getElementById('vozduh-view');
            const historyView = document.getElementById('history-view');
            const historyTitle = document.getElementById('history-title');
            const historyTableBody = document.getElementById('history-table-body');
            const tabKlimat = document.getElementById('tab-klimat');
            const tabVozduh = document.getElementById('tab-vozduh');
            // MODAL Elements
            const confirmModal = document.getElementById('confirm-modal');
            const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            // EDIT MODAL Elements
            const editModal = document.getElementById('edit-modal');
            const editModalTitle = document.getElementById('edit-modal-title');
            const editForm = document.getElementById('edit-form');
            const editCancelBtn = document.getElementById('edit-cancel-btn');
            
            const themeToggle = document.getElementById('theme-toggle');
            const docHtml = document.documentElement;
            const addKlimatForm = document.getElementById('add-klimat-form');
            const klimatTableBody = document.getElementById('klimat-table-body');
            const historyBtn = document.getElementById('history-btn');
            const backBtn = document.getElementById('back-btn');
            const addVozduhForm = document.getElementById('add-vozduh-form');
            const vozduhTableBody = document.getElementById('vozduh-table-body');


            // --- Authentication State Observer ---
            onAuthStateChanged(auth, user => {
                if (user) {
                    currentUserEmail = user.email;
                    authContainer.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    userEmailEl.textContent = user.email;
                    if (user.email === ADMIN_EMAIL) {
                        historyBtn.classList.remove('hidden');
                    }
                    initializeAppLogic();
                } else {
                    currentUserEmail = null;
                    authContainer.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                    userEmailEl.textContent = '';
                    historyBtn.classList.add('hidden');
                    if (unsubscribeKlimat) unsubscribeKlimat();
                    if (unsubscribeKlimatHistory) unsubscribeKlimatHistory();
                    if (unsubscribeVozduh) unsubscribeVozduh();
                    if (unsubscribeVozduhHistory) unsubscribeVozduhHistory();
                }
            });

            // --- Authentication Handlers ---
            showRegisterBtn.addEventListener('click', (e) => { e.preventDefault(); loginView.classList.add('hidden'); registerView.classList.remove('hidden'); });
            showLoginBtn.addEventListener('click', (e) => { e.preventDefault(); registerView.classList.add('hidden'); loginView.classList.remove('hidden'); });
            registerForm.addEventListener('submit', (e) => { e.preventDefault(); handleRegistration(); });
            loginForm.addEventListener('submit', (e) => { e.preventDefault(); handleLogin(); });
            logoutBtn.addEventListener('click', () => { signOut(auth).catch(error => console.error("Logout error:", error)); });

            function handleRegistration() {
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                createUserWithEmailAndPassword(auth, email, password).catch(handleAuthError(registerError));
            }

            function handleLogin() {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                signInWithEmailAndPassword(auth, email, password).catch(handleAuthError(loginError));
            }
            
            function handleAuthError(errorElement) {
                return function(error) {
                    console.error("Auth error:", error);
                    errorElement.textContent = "–û—à–∏–±–∫–∞: " + error.message;
                    errorElement.classList.remove('hidden');
                }
            }
            
            // --- Main App Logic Initializer ---
            function initializeAppLogic() {
                setupEventListeners();
                listenForKlimatDataChanges();
                listenForVozduhDataChanges();
                seedVozduhDataFromPDF(); 
                setDefaultDateTimes();
            }

            // --- Theme Toggle Logic ---
            function applyTheme() {
                if (themeToggle.checked) {
                    docHtml.classList.add('light');
                    localStorage.setItem('theme', 'light');
                } else {
                    docHtml.classList.remove('light');
                    localStorage.setItem('theme', 'dark');
                }
            }
            if (localStorage.getItem('theme') === 'light') themeToggle.checked = true;
            else themeToggle.checked = false;
            applyTheme();
            themeToggle.addEventListener('change', applyTheme);

            // --- Tab Navigation ---
            function handleTabClick(event) {
                lastActiveTabId = event.currentTarget.id;
                document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('#klimat-view, #vozduh-view').forEach(view => view.classList.add('hidden'));
                event.currentTarget.classList.add('active');
                document.getElementById(event.currentTarget.dataset.view).classList.remove('hidden');
                if(currentUserEmail === ADMIN_EMAIL){
                    historyBtn.textContent = lastActiveTabId === 'tab-klimat' ? '–û–±—â–∞—è –∏—Å—Ç–æ—Ä–∏—è –ö–ª–∏–º–∞—Ç' : '–û–±—â–∞—è –∏—Å—Ç–æ—Ä–∏—è –ö–∞—á–µ—Å—Ç–≤–æ –≤–æ–∑–¥—É—Ö–∞';
                }
                historyView.classList.add('hidden');
            }
            tabKlimat.addEventListener('click', handleTabClick);
            tabVozduh.addEventListener('click', handleTabClick);
            
            // #############################################
            // #          KLIMAT GIP SECTION             #
            // #############################################
            const klimatDataRef = collection(db, `artifacts/${appId}/public/data/gip_stats`);
            const klimatHistoryRef = collection(db, `artifacts/${appId}/public/data/gip_stats_history`);

            function listenForKlimatDataChanges() {
                const q = query(klimatDataRef, orderBy('date', 'desc'));
                unsubscribeKlimat = onSnapshot(q, (snapshot) => {
                    allKlimatEntries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderKlimatTable(allKlimatEntries);
                }, (error) => console.error("Error loading Klimat data:", error));
            }
            
            function renderKlimatTable(data) {
                const tableBody = klimatTableBody;
                const loadingState = document.getElementById('klimat-loading');
                const tableContainer = document.getElementById('klimat-table-container');
                tableBody.innerHTML = '';
                if (data.length === 0) {
                    loadingState.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.';
                    loadingState.classList.remove('hidden');
                    tableContainer.classList.add('hidden');
                    return;
                }
                loadingState.classList.add('hidden');
                tableContainer.classList.remove('hidden');
                
                const groupedData = {};
                data.forEach(entry => {
                    const entryDate = entry.date.toDate();
                    const dateKey = entryDate.toDateString();
                    if (!groupedData[dateKey]) groupedData[dateKey] = [];
                    groupedData[dateKey].push({ ...entry, date: entryDate });
                });

                const sortedDates = Object.keys(groupedData).sort((a, b) => new Date(b) - new Date(a));

                sortedDates.forEach(dateKey => {
                    const date = new Date(dateKey);
                    const formattedDate = date.toLocaleDateString('ru-RU', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                    const dateRow = document.createElement('tr');
                    dateRow.innerHTML = `<td colspan="11" class="px-6 py-2 text-sm font-semibold" style="background-color: var(--date-header-bg);">${formattedDate}</td>`;
                    tableBody.appendChild(dateRow);

                    const entriesForDay = groupedData[dateKey].sort((a, b) => a.date - b.date);
                    entriesForDay.forEach(entry => {
                        const row = document.createElement('tr');
                        const isProblem = entry.comment && entry.comment.trim() !== '–ü—Ä–æ—Å—Ç—Ä–µ–ª–æ–≤, –ø–æ–ª–æ—Å –Ω–µ—Ç';
                        if (isProblem) row.style.backgroundColor = 'var(--problem-bg)';
                        row.style.transition = 'background-color 0.3s';
                        row.addEventListener('mouseover', () => { row.style.backgroundColor = isProblem ? 'var(--problem-hover-bg)' : 'var(--hover-bg)'; });
                        row.addEventListener('mouseout', () => { row.style.backgroundColor = isProblem ? 'var(--problem-bg)' : 'transparent'; });
                        const formattedTime = entry.date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });

                        row.innerHTML = `
                            <td class="px-6 py-4 text-center align-middle text-sm">${formattedTime}</td>
                            <td class="px-6 py-4 text-center align-middle text-sm">${entry.temp ?? ''}</td>
                            <td class="px-6 py-4 text-center align-middle text-sm">${entry.humidity ?? ''}</td>
                            <td class="px-6 py-4 text-center align-middle text-sm">${entry.pressure ?? ''}</td>
                            <td class="px-6 py-4 text-center align-middle text-sm">${entry.cyan ?? ''}</td>
                            <td class="px-6 py-4 text-center align-middle text-sm">${entry.magenta ?? ''}</td>
                            <td class="px-6 py-4 text-center align-middle text-sm">${entry.yellow ?? ''}</td>
                            <td class="px-6 py-4 text-center align-middle text-sm">${entry.black ?? ''}</td>
                            <td class="px-6 py-4 text-center align-middle text-sm">${entry.white ?? ''}</td>
                            <td class="px-6 py-4 text-center align-middle text-sm">${entry.comment || ''}</td>
                            <td class="px-6 py-4 text-center align-middle text-sm">
                                <div class="flex items-center justify-center gap-2">
                                    <button data-id="${entry.id}" data-type="klimat" class="edit-btn p-1 hover:text-yellow-500" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z" /></svg>
                                    </button>
                                    <button data-id="${entry.id}" data-type="klimat" class="delete-btn p-1 hover:text-red-500" title="–£–¥–∞–ª–∏—Ç—å">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                    </button>
                                </div>
                            </td>`;
                        tableBody.appendChild(row);
                    });
                });
            }

            async function handleAddKlimatEntry(e) {
                e.preventDefault();
                const dateValue = document.getElementById('klimat-date').value;
                const timeValue = document.getElementById('klimat-time').value;
                if (!dateValue || !timeValue) return;

                const commentSelect = document.getElementById('klimat-comment');
                let commentValue = commentSelect.value;
                if (commentValue === 'other') {
                    commentValue = document.getElementById('klimat-custom-comment').value || '';
                }
                
                const newEntryData = {
                    date: new Date(`${dateValue}T${timeValue}`),
                    temp: parseFloat(document.getElementById('temp').value),
                    humidity: parseFloat(document.getElementById('humidity').value),
                    pressure: parseFloat(document.getElementById('pressure').value),
                    cyan: parseFloat(document.getElementById('cyan').value),
                    magenta: parseFloat(document.getElementById('magenta').value),
                    yellow: parseFloat(document.getElementById('yellow').value),
                    black: parseFloat(document.getElementById('black').value),
                    white: parseFloat(document.getElementById('white').value),
                    comment: commentValue,
                    createdAt: serverTimestamp()
                };

                try {
                    const docRef = await addDoc(klimatDataRef, newEntryData);
                    const logDetails = { ...newEntryData, date: newEntryData.date.toISOString() };
                    delete logDetails.createdAt;
                    await logKlimatHistory('create', docRef.id, { newData: logDetails });
                    e.target.reset();
                    setDefaultDateTimes();
                    document.getElementById('klimat-custom-comment-wrapper').classList.add('hidden');
                } catch (error) {
                    console.error("Failed to add Klimat entry:", error);
                }
            }
            
            // #############################################
            // #    VOZDUH (AIR QUALITY) SECTION         #
            // #############################################
            const vozduhDataRef = collection(db, `artifacts/${appId}/public/data/air_quality_records`);
            const vozduhHistoryRef = collection(db, `artifacts/${appId}/public/data/air_quality_history`);

            const vozduhParams = {
                hcho: { thresholds: { good: 0.01, moderate: 0.05 } },
                tvoc: { thresholds: { good: 0.3, moderate: 1.0 } },
                pm25: { thresholds: { good: 15, moderate: 35 } },
                pm10: { thresholds: { good: 45, moderate: 75 } },
                co2:  { thresholds: { good: 800, moderate: 1200 } }
            };

            function listenForVozduhDataChanges() {
                const q = query(vozduhDataRef, orderBy('datetime', 'desc'));
                unsubscribeVozduh = onSnapshot(q, (snapshot) => {
                    allVozduhRecords = snapshot.docs.map(doc => {
                        const data = doc.data();
                        const jsDate = data.datetime.toDate();
                        return { id: doc.id, ...data, datetime: jsDate, date: jsDate.toISOString().slice(0, 10) }
                    });
                    renderVozduhTable(allVozduhRecords);
                }, (error) => console.error("Error loading Vozduh data:", error));
            }

            function renderVozduhTable(data) {
                const tableBody = vozduhTableBody;
                const loadingState = document.getElementById('vozduh-loading');
                const tableContainer = document.getElementById('vozduh-table-container');
                tableBody.innerHTML = '';
                
                if (data.length === 0) {
                    loadingState.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å.';
                    loadingState.classList.remove('hidden');
                    tableContainer.classList.add('hidden');
                    return;
                }
                
                loadingState.classList.add('hidden');
                tableContainer.classList.remove('hidden');

                let lastDate = null;
                data.forEach(record => {
                    const currentDate = record.date;
                    if (currentDate !== lastDate) {
                        const formattedDate = new Date(currentDate).toLocaleDateString('ru-RU', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                        const headerRow = document.createElement('tr');
                        headerRow.innerHTML = `<td colspan="8" class="px-6 py-2 font-bold" style="background-color: var(--date-header-bg);">${formattedDate}</td>`;
                        tableBody.appendChild(headerRow);
                        lastDate = currentDate;
                    }
                    
                    const row = document.createElement('tr');
                    row.style.transition = 'background-color 0.3s';
                    row.addEventListener('mouseover', () => { row.style.backgroundColor = 'var(--hover-bg)'; });
                    row.addEventListener('mouseout', () => { row.style.backgroundColor = 'transparent'; });
                    
                    const formattedTime = record.datetime.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });

                    let cellsHTML = `<td class="px-6 py-4 text-sm font-medium whitespace-nowrap">${formattedTime}</td>`;
                    Object.keys(vozduhParams).forEach(key => {
                        const value = record[key];
                        const statusClass = (v, c) => v === null || v === undefined ? '' : v > c.thresholds.moderate ? 'status-bad' : v > c.thresholds.good ? 'status-moderate' : 'status-good';
                        const formattedValue = value !== null ? value.toFixed(key === 'co2' ? 0 : 3) : '--';
                        cellsHTML += `<td class="px-6 py-4 text-sm"><span class="status-dot ${statusClass(value, vozduhParams[key])}"></span><span>${formattedValue}</span></td>`;
                    });
                    
                    cellsHTML += `
                        <td class="px-6 py-4 text-sm text-secondary whitespace-pre-wrap">${record.comment || '--'}</td>
                        <td class="px-6 py-4 text-sm">
                            <div class="flex items-center space-x-2">
                                 <button title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å" class="edit-btn p-1 hover:text-yellow-500" data-type="vozduh" data-id="${record.id}">
                                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z" /></svg>
                                </button>
                                <button title="–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å" class="delete-btn p-1 hover:text-red-500" data-type="vozduh" data-id="${record.id}">
                                    <svg class="w-5 h-5 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>
                        </td>`;
                    row.innerHTML = cellsHTML;
                    tableBody.appendChild(row);
                });
            }
            
            async function handleAddVozduhRecord(event) {
                event.preventDefault();
                const date = document.getElementById('vozduh-date').value;
                const time = document.getElementById('vozduh-time').value;

                const newRecord = {
                    datetime: Timestamp.fromDate(new Date(`${date}T${time}`)),
                    hcho: parseFloat(document.getElementById('hcho').value),
                    tvoc: parseFloat(document.getElementById('tvoc').value),
                    pm25: parseFloat(document.getElementById('pm25').value),
                    pm10: parseFloat(document.getElementById('pm10').value),
                    co2:  parseFloat(document.getElementById('co2').value),
                    comment: document.getElementById('vozduh-comment').value.trim() || null
                };

                try {
                    const docRef = await addDoc(vozduhDataRef, newRecord);
                    const logDetails = { ...newRecord, datetime: newRecord.datetime.toDate().toISOString() };
                    await logVozduhHistory('create', docRef.id, { newData: logDetails });
                    event.target.reset();
                    setDefaultDateTimes();
                } catch (e) {
                    console.error("Error adding Vozduh document: ", e);
                }
            }
            
            // #############################################
            // #      PDF DATA SEEDING SECTION           #
            // #############################################
            
            async function seedVozduhDataFromPDF() {
                const snapshot = await getDocs(query(vozduhDataRef));
                if (!snapshot.empty) {
                    return;
                }
                
                console.log("Air quality collection is empty. Seeding data from PDF...");

                const pdfData = [
                    { date: "2025-08-13", time: "09:10", hcho: 0.112, tvoc: 0.308, pm25: 0.11, pm10: 0.15, co2: 1080, comment: null },
                    { date: "2025-08-13", time: "18:52", hcho: 0.351, tvoc: 0.960, pm25: 0.14, pm10: 0.19, co2: 1762, comment: null },
                    { date: "2025-08-14", time: "12:00", hcho: 0.584, tvoc: 1.576, pm25: 0.27, pm10: 0.37, co2: 2043, comment: "–í —Å–µ—Ä–µ–¥–∏–Ω–µ —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è –Ω–µ —Ö–≤–∞—Ç–∞–ª–æ –∫–∏—Å–ª–æ—Ä–æ–¥–∞." },
                    { date: "2025-08-14", time: "19:30", hcho: 0.100, tvoc: 0.316, pm25: 0.12, pm10: 0.15, co2: 1020, comment: null },
                    { date: "2025-08-15", time: "09:15", hcho: 0.523, tvoc: 1.464, pm25: 0.17, pm10: 0.23, co2: 2004, comment: null },
                    { date: "2025-08-15", time: "19:15", hcho: 0.040, tvoc: 0.123, pm25: 0.11, pm10: 0.16, co2: 706, comment: null },
                    { date: "2025-08-16", time: "09:15", hcho: 0.048, tvoc: 0.123, pm25: 0.11, pm10: 0.15, co2: 723, comment: null },
                    { date: "2025-08-16", time: "19:50", hcho: 0.012, tvoc: 0.033, pm25: 0.11, pm10: 0.18, co2: 470, comment: null },
                    { date: "2025-08-17", time: "09:15", hcho: 0.284, tvoc: 1.576, pm25: 0.22, pm10: 0.30, co2: 1783, comment: null },
                    { date: "2025-08-17", time: "19:50", hcho: 0.210, tvoc: 0.518, pm25: 0.16, pm10: 0.22, co2: 1515, comment: null },
                    { date: "2025-08-18", time: "09:30", hcho: 1.500, tvoc: 1.700, pm25: 0.57, pm10: 0.79, co2: 3627, comment: null },
                    { date: "2025-08-18", time: "20:15", hcho: 0.357, tvoc: 1.022, pm25: 0.12, pm10: 0.14, co2: 1823, comment: null },
                    { date: "2025-08-19", time: "09:05", hcho: 0.980, tvoc: 1.743, pm25: 0.19, pm10: 0.22, co2: 2659, comment: null },
                    { date: "2025-08-19", time: "20:55", hcho: 0.122, tvoc: 0.347, pm25: 0.12, pm10: 0.18, co2: 1157, comment: null },
                    { date: "2025-08-20", time: "09:05", hcho: 1.956, tvoc: 1.999, pm25: 0.30, pm10: 0.40, co2: 4204, comment: null },
                    { date: "2025-08-21", time: "09:05", hcho: 0.000, tvoc: 0.000, pm25: 0.10, pm10: 0.16, co2: 101, comment: null },
                    { date: "2025-08-22", time: "19:40", hcho: 1.707, tvoc: 1.290, pm25: 0.79, pm10: 1.10, co2: 3792, comment: null },
                    { date: "2025-08-24", time: "09:05", hcho: 0.926, tvoc: 1.600, pm25: 0.11, pm10: 0.16, co2: 2664, comment: null },
                    { date: "2025-08-25", time: "09:20", hcho: 0.300, tvoc: 1.100, pm25: 0.22, pm10: 0.30, co2: 1806, comment: null },
                    { date: "2025-08-26", time: "10:00", hcho: 0.000, tvoc: 0.000, pm25: 0.13, pm10: 0.15, co2: 109, comment: null },
                    { date: "2025-08-26", time: "20:40", hcho: 0.012, tvoc: 0.039, pm25: 0.63, pm10: 0.88, co2: 459, comment: null },
                    { date: "2025-08-27", time: "09:05", hcho: 0.158, tvoc: 0.445, pm25: 0.11, pm10: 0.18, co2: 1355, comment: null },
                    { date: "2025-08-27", time: "20:45", hcho: 1.697, tvoc: 1.270, pm25: 0.19, pm10: 0.26, co2: 3808, comment: null },
                    { date: "2025-08-28", time: "09:05", hcho: 0.000, tvoc: 0.000, pm25: 0.13, pm10: 0.18, co2: 11, comment: null },
                    { date: "2025-08-28", time: "20:50", hcho: 0.012, tvoc: 0.047, pm25: 0.49, pm10: 0.67, co2: 443, comment: null },
                    { date: "2025-08-29", time: "09:10", hcho: 1.034, tvoc: 1.240, pm25: 0.30, pm10: 0.42, co2: 2340, comment: null },
                    { date: "2025-08-29", time: "20:20", hcho: 1.300, tvoc: 1.929, pm25: 0.49, pm10: 0.68, co2: 3209, comment: null },
                    { date: "2025-08-30", time: "11:10", hcho: 0.680, tvoc: 1.900, pm25: 0.22, pm10: 0.30, co2: 2219, comment: null },
                    { date: "2025-08-30", time: "20:10", hcho: 1.600, tvoc: 1.100, pm25: 0.30, pm10: 0.50, co2: 3682, comment: null },
                    { date: "2025-08-31", time: "09:15", hcho: 0.500, tvoc: 1.400, pm25: 0.11, pm10: 0.18, co2: 1971, comment: null },
                    { date: "2025-08-31", time: "20:00", hcho: 0.150, tvoc: 0.500, pm25: 0.11, pm10: 0.15, co2: 470, comment: null },
                    { date: "2025-09-01", time: "13:00", hcho: 0.483, tvoc: 1.243, pm25: 30.0, pm10: 42.0, co2: 1790, comment: null },
                    { date: "2025-09-03", time: "11:30", hcho: 0.210, tvoc: 0.588, pm25: 22.0, pm10: 29.0, co2: 1564, comment: null },
                    { date: "2025-09-03", time: "17:50", hcho: 1.265, tvoc: 1.930, pm25: 35.0, pm10: 50.0, co2: 3258, comment: null },
                    { date: "2025-09-04", time: "09:10", hcho: 0.570, tvoc: 1.600, pm25: 0.20, pm10: 0.28, co2: 2076, comment: null }
                ];

                const batch = writeBatch(db);
                pdfData.forEach(record => {
                    const docRef = doc(vozduhDataRef); 
                    const newRecord = {
                        datetime: Timestamp.fromDate(new Date(`${record.date}T${record.time}`)),
                        hcho: record.hcho,
                        tvoc: record.tvoc,
                        pm25: record.pm25,
                        pm10: record.pm10,
                        co2: record.co2,
                        comment: record.comment
                    };
                    batch.set(docRef, newRecord);
                });

                try {
                    await batch.commit();
                    console.log("Successfully seeded air quality data from PDF!");
                } catch (error) {
                    console.error("Error seeding air quality data: ", error);
                }
            }


            // #############################################
            // #      GENERAL & SHARED SECTION           #
            // #############################################
            
            function setupEventListeners() {
                // Main View Listeners
                addKlimatForm.addEventListener('submit', handleAddKlimatEntry);
                addVozduhForm.addEventListener('submit', handleAddVozduhRecord);
                
                klimatTableBody.addEventListener('click', handleTableActions);
                vozduhTableBody.addEventListener('click', handleTableActions);

                document.getElementById('klimat-comment').addEventListener('change', (e) => {
                    document.getElementById('klimat-custom-comment-wrapper').classList.toggle('hidden', e.target.value !== 'other');
                });
                
                // Search Listeners
                document.getElementById('search-btn').addEventListener('click', handleKlimatSearch);
                document.getElementById('reset-btn').addEventListener('click', resetKlimatSearch);
                document.getElementById('vozduh-search-btn').addEventListener('click', handleVozduhSearch);
                document.getElementById('vozduh-reset-btn').addEventListener('click', resetVozduhSearch);

                // History Listeners
                historyBtn.addEventListener('click', showHistoryView);
                backBtn.addEventListener('click', () => { 
                    historyView.classList.add('hidden');
                    document.getElementById(lastActiveTabId === 'tab-klimat' ? 'klimat-view' : 'vozduh-view').classList.remove('hidden');
                    if(unsubscribeKlimatHistory) unsubscribeKlimatHistory();
                    if(unsubscribeVozduhHistory) unsubscribeVozduhHistory();
                });
                
                // Custom confirmation modal listeners
                confirmCancelBtn.addEventListener('click', () => {
                    confirmModal.classList.add('hidden');
                });
                confirmDeleteBtn.addEventListener('click', handleConfirmDelete);

                // Edit modal listeners
                editForm.addEventListener('submit', handleUpdateEntry);
                editCancelBtn.addEventListener('click', () => {
                    editModal.classList.add('hidden');
                });
            }

            function handleTableActions(e) {
                const button = e.target.closest('button');
                if (!button) return;
                
                const docId = button.dataset.id;
                const type = button.dataset.type;

                if (button.classList.contains('delete-btn')) {
                    itemToDeleteContext = { id: docId, type: type };
                    confirmModal.classList.remove('hidden');
                } else if (button.classList.contains('edit-btn')) {
                    openEditModal(docId, type);
                }
            }
            
            async function openEditModal(docId, type) {
                const dataRef = type === 'klimat' ? klimatDataRef : vozduhDataRef;
                const docRef = doc(dataRef, docId);

                try {
                    const docSnap = await getDoc(docRef);
                    if (!docSnap.exists()) {
                        console.error("Document not found for editing!");
                        return;
                    }
                    const data = docSnap.data();
                    itemToEditContext = { id: docId, type: type, data: data };

                    editModalTitle.textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å: ${type === 'klimat' ? '–ö–ª–∏–º–∞—Ç' : '–ö–∞—á–µ—Å—Ç–≤–æ –≤–æ–∑–¥—É—Ö–∞'}`;
                    populateEditForm(data, type);
                    editModal.classList.remove('hidden');

                } catch (error) {
                    console.error("Error fetching document for edit:", error);
                }
            }
            
            function populateEditForm(data, type) {
                editForm.innerHTML = ''; // Clear previous form
                if (type === 'klimat') {
                    const entryDate = data.date.toDate();
                    const dateValue = entryDate.toISOString().slice(0, 10);
                    const timeValue = entryDate.toISOString().slice(11, 16);
                    const standardComments = ["–ü—Ä–æ—Å—Ç—Ä–µ–ª–æ–≤, –ø–æ–ª–æ—Å –Ω–µ—Ç"];
                    const isCustomComment = data.comment && !standardComments.includes(data.comment);
                    editForm.innerHTML = `
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div><label for="edit-klimat-date" class="block text-sm font-medium text-secondary">–î–∞—Ç–∞</label><input type="date" id="edit-klimat-date" class="mt-1 form-input" value="${dateValue}" required></div>
                            <div><label for="edit-klimat-time" class="block text-sm font-medium text-secondary">–í—Ä–µ–º—è</label><input type="time" id="edit-klimat-time" class="mt-1 form-input" value="${timeValue}" required></div>
                        </div>
                        <div>
                            <h3 class="text-md font-semibold text-primary mb-2">–ö–ª–∏–º–∞—Ç</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                <div><label class="block text-sm font-medium text-secondary">–¢–µ–º–ø. (¬∞–°)</label><input type="number" step="0.001" id="edit-temp" class="mt-1 form-input" value="${data.temp}" required></div>
                                <div><label class="block text-sm font-medium text-secondary">–í–ª–∞–∂–Ω. (%)</label><input type="number" step="0.001" id="edit-humidity" class="mt-1 form-input" value="${data.humidity}" required></div>
                                <div><label class="block text-sm font-medium text-secondary">–î–∞–≤–ª. (–º–º)</label><input type="number" step="0.001" id="edit-pressure" class="mt-1 form-input" value="${data.pressure}" required></div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-md font-semibold text-primary mb-2">–î–∞–≤–ª–µ–Ω–∏–µ GIP</h3>
                            <div class="grid grid-cols-2 sm:grid-cols-5 gap-4">
                                <div><label class="block text-sm font-medium text-secondary">Cyan</label><input type="number" step="0.001" id="edit-cyan" class="mt-1 form-input" value="${data.cyan}" required></div>
                                <div><label class="block text-sm font-medium text-secondary">Magenta</label><input type="number" step="0.001" id="edit-magenta" class="mt-1 form-input" value="${data.magenta}" required></div>
                                <div><label class="block text-sm font-medium text-secondary">Yellow</label><input type="number" step="0.001" id="edit-yellow" class="mt-1 form-input" value="${data.yellow}" required></div>
                                <div><label class="block text-sm font-medium text-secondary">Black</label><input type="number" step="0.001" id="edit-black" class="mt-1 form-input" value="${data.black}" required></div>
                                <div><label class="block text-sm font-medium text-secondary">White</label><input type="number" step="0.001" id="edit-white" class="mt-1 form-input" value="${data.white}" required></div>
                            </div>
                        </div>
                        <div>
                            <label for="edit-klimat-comment" class="block text-sm font-medium text-secondary">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                            <select id="edit-klimat-comment" class="mt-1 form-select">
                                <option value="–ü—Ä–æ—Å—Ç—Ä–µ–ª–æ–≤, –ø–æ–ª–æ—Å –Ω–µ—Ç" ${!isCustomComment ? 'selected' : ''}>–ü—Ä–æ—Å—Ç—Ä–µ–ª–æ–≤, –ø–æ–ª–æ—Å –Ω–µ—Ç</option>
                                <option value="other" ${isCustomComment ? 'selected' : ''}>–î—Ä—É–≥–æ–µ (–≤–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é)</option>
                            </select>
                            <div id="edit-klimat-custom-comment-wrapper" class="${isCustomComment ? '' : 'hidden'} mt-2">
                                <input type="text" id="edit-klimat-custom-comment" class="mt-1 form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." value="${isCustomComment ? data.comment : ''}">
                            </div>
                        </div>`;
                    document.getElementById('edit-klimat-comment').addEventListener('change', (e) => {
                        document.getElementById('edit-klimat-custom-comment-wrapper').classList.toggle('hidden', e.target.value !== 'other');
                    });
                } else if (type === 'vozduh') {
                    const entryDate = data.datetime.toDate();
                    const dateValue = entryDate.toISOString().slice(0, 10);
                    const timeValue = entryDate.toISOString().slice(11, 16);
                    editForm.innerHTML = `
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div><label for="edit-vozduh-date" class="block text-sm font-medium text-secondary">–î–∞—Ç–∞</label><input type="date" id="edit-vozduh-date" class="mt-1 form-input" value="${dateValue}" required></div>
                            <div><label for="edit-vozduh-time" class="block text-sm font-medium text-secondary">–í—Ä–µ–º—è</label><input type="time" id="edit-vozduh-time" class="mt-1 form-input" value="${timeValue}" required></div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                            <div><label class="block text-sm font-medium text-secondary">HCHO</label><input type="number" step="0.001" id="edit-hcho" class="mt-1 form-input" value="${data.hcho}" required></div>
                            <div><label class="block text-sm font-medium text-secondary">TVOC</label><input type="number" step="0.001" id="edit-tvoc" class="mt-1 form-input" value="${data.tvoc}" required></div>
                            <div><label class="block text-sm font-medium text-secondary">PM2.5</label><input type="number" step="0.001" id="edit-pm25" class="mt-1 form-input" value="${data.pm25}" required></div>
                            <div><label class="block text-sm font-medium text-secondary">PM10</label><input type="number" step="0.001" id="edit-pm10" class="mt-1 form-input" value="${data.pm10}" required></div>
                            <div><label class="block text-sm font-medium text-secondary">CO2</label><input type="number" step="0.001" id="edit-co2" class="mt-1 form-input" value="${data.co2}" required></div>
                        </div>
                        <div>
                            <label for="edit-vozduh-comment" class="block text-sm font-medium text-secondary">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                            <textarea id="edit-vozduh-comment" rows="2" class="mt-1 form-textarea" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...">${data.comment || ''}</textarea>
                        </div>`;
                }
            }
            
            async function handleUpdateEntry(e) {
                e.preventDefault();
                const { id, type, data: oldData } = itemToEditContext;
                if (!id || !type) return;

                let newData;
                const dataRef = type === 'klimat' ? klimatDataRef : vozduhDataRef;
                const docRef = doc(dataRef, id);

                if (type === 'klimat') {
                    const dateValue = document.getElementById('edit-klimat-date').value;
                    const timeValue = document.getElementById('edit-klimat-time').value;
                    const commentSelect = document.getElementById('edit-klimat-comment');
                    let commentValue = commentSelect.value;
                    if (commentValue === 'other') {
                        commentValue = document.getElementById('edit-klimat-custom-comment').value || '';
                    }
                    newData = {
                        date: new Date(`${dateValue}T${timeValue}`),
                        temp: parseFloat(document.getElementById('edit-temp').value),
                        humidity: parseFloat(document.getElementById('edit-humidity').value),
                        pressure: parseFloat(document.getElementById('edit-pressure').value),
                        cyan: parseFloat(document.getElementById('edit-cyan').value),
                        magenta: parseFloat(document.getElementById('edit-magenta').value),
                        yellow: parseFloat(document.getElementById('edit-yellow').value),
                        black: parseFloat(document.getElementById('edit-black').value),
                        white: parseFloat(document.getElementById('edit-white').value),
                        comment: commentValue,
                    };
                } else if (type === 'vozduh') {
                    const date = document.getElementById('edit-vozduh-date').value;
                    const time = document.getElementById('edit-vozduh-time').value;
                    newData = {
                        datetime: Timestamp.fromDate(new Date(`${date}T${time}`)),
                        hcho: parseFloat(document.getElementById('edit-hcho').value),
                        tvoc: parseFloat(document.getElementById('edit-tvoc').value),
                        pm25: parseFloat(document.getElementById('edit-pm25').value),
                        pm10: parseFloat(document.getElementById('edit-pm10').value),
                        co2: parseFloat(document.getElementById('edit-co2').value),
                        comment: document.getElementById('edit-vozduh-comment').value.trim() || null
                    };
                }

                try {
                    await updateDoc(docRef, newData);
                    if (type === 'klimat') {
                        await logKlimatHistory('update', id, { oldData, newData });
                    } else {
                        await logVozduhHistory('update', id, { oldData, newData });
                    }
                } catch (error) {
                    console.error("Failed to update entry:", error);
                } finally {
                    editModal.classList.add('hidden');
                    itemToEditContext = { id: null, type: null, data: null };
                }
            }


            function handleConfirmDelete() {
                const { id, type } = itemToDeleteContext;
                if (id && type) {
                    if (type === 'klimat') handleDeleteKlimatEntry(id);
                    else if (type === 'vozduh') handleDeleteVozduhEntry(id);
                }
                confirmModal.classList.add('hidden');
                itemToDeleteContext = { id: null, type: null }; // Reset context
            }


            async function handleDeleteKlimatEntry(docId) {
                const docRef = doc(klimatDataRef, docId);
                try {
                    const docSnap = await getDoc(docRef);
                    if(!docSnap.exists()) return;
                    const deletedData = docSnap.data();
                    await deleteDoc(docRef);
                    await logKlimatHistory('delete', docId, { deletedData });
                } catch(error) {
                    console.error("Failed to delete Klimat entry:", error);
                }
            }

            async function handleDeleteVozduhEntry(docId) {
                const docRef = doc(vozduhDataRef, docId);
                try {
                     const docSnap = await getDoc(docRef);
                    if(!docSnap.exists()) return;
                    const deletedData = docSnap.data();
                    await deleteDoc(docRef);
                    await logVozduhHistory('delete', docId, { deletedData });
                } catch(error) {
                    console.error("Failed to delete Vozduh entry:", error);
                }
            }

            // --- History & Search ---
            function handleKlimatSearch() {
                const searchDateVal = document.getElementById('search-date').value;
                if (!searchDateVal) { renderKlimatTable(allKlimatEntries); return; }
                const searchDate = new Date(searchDateVal);
                const filteredData = allKlimatEntries.filter(entry => {
                    const entryDate = entry.date.toDate();
                    return entryDate.getFullYear() === searchDate.getFullYear() &&
                           entryDate.getMonth() === searchDate.getMonth() &&
                           entryDate.getDate() === searchDate.getDate();
                });
                renderKlimatTable(filteredData);
            }

            function resetKlimatSearch() {
                document.getElementById('search-date').value = '';
                renderKlimatTable(allKlimatEntries);
            }

            function showHistoryView() {
                klimatView.classList.add('hidden');
                vozduhView.classList.add('hidden');
                historyView.classList.remove('hidden');

                if (lastActiveTabId === 'tab-klimat') {
                    initializeKlimatHistoryView();
                } else {
                    initializeVozduhHistoryView();
                }
            }
            
            // Klimat History
            function initializeKlimatHistoryView() {
                historyTitle.textContent = "–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –ö–ª–∏–º–∞—Ç";
                const q = query(klimatHistoryRef, orderBy('timestamp', 'desc'));
                unsubscribeKlimatHistory = onSnapshot(q, (snapshot) => {
                    renderKlimatHistory(snapshot.docs.map(doc => doc.data()));
                });
            }
             async function logKlimatHistory(action, docId, details) {
                const logData = { ...details };
                if (logData.oldData?.date?.toDate) logData.oldData.date = logData.oldData.date.toDate().toISOString();
                if (logData.newData?.date?.toDate) logData.newData.date = logData.newData.date.toDate().toISOString();
                if (logData.deletedData?.date?.toDate) logData.deletedData.date = logData.deletedData.date.toDate().toISOString();
                try {
                    await addDoc(klimatHistoryRef, { action, docId, details: logData, userEmail: currentUserEmail, timestamp: serverTimestamp() });
                } catch(error) { console.error("Failed to log Klimat history:", error); }
            }
            function renderKlimatHistory(historyData) {
                historyTableBody.innerHTML = '';
                if (historyData.length === 0) {
                    historyTableBody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-secondary">–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—É—Å—Ç–∞.</td></tr>';
                    return;
                }
                historyData.forEach(log => {
                    const row = document.createElement('tr');
                    const date = log.timestamp?.toDate ? log.timestamp.toDate().toLocaleString('ru-RU') : 'N/A';
                    let detailsHtml = '';
                    if (log.action === 'create' && log.details?.newData) {
                        detailsHtml = `–°–æ–∑–¥–∞–Ω–∞ –∑–∞–ø–∏—Å—å. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: "${log.details.newData.comment || ''}"`;
                    } else if (log.action === 'delete' && log.details?.deletedData) {
                        detailsHtml = `–£–¥–∞–ª–µ–Ω–∞ –∑–∞–ø–∏—Å—å. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –±—ã–ª: "${log.details.deletedData.comment || ''}"`;
                    } else if (log.action === 'update' && log.details?.newData && log.details?.oldData) {
                         const changes = Object.keys(log.details.newData).reduce((acc, key) => {
                            const oldValue = log.details.oldData[key] ?? '–ø—É—Å—Ç–æ';
                            const newValue = log.details.newData[key] ?? '–ø—É—Å—Ç–æ';
                            
                            // Handle date/timestamp objects for comparison
                            const oldValStr = oldValue?.toDate ? oldValue.toDate().toISOString() : String(oldValue);
                            const newValStr = newValue?.toDate ? newValue.toDate().toISOString() : String(newValue);

                            if (oldValStr !== newValStr) {
                                acc.push(`<b>${key}</b>: "${oldValStr}" -> "${newValStr}"`);
                            }
                            return acc;
                        }, []);
                        detailsHtml = changes.length > 0 ? `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${changes.join('<br>')}` : '–ó–∞–ø–∏—Å—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π).';
                    } else {
                        detailsHtml = `–î–µ–π—Å—Ç–≤–∏–µ "${log.action}" (–Ω–µ—Ç –¥–µ—Ç–∞–ª–µ–π)`;
                    }

                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-secondary">${log.userEmail}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-secondary">${log.action}</td>
                        <td class="px-6 py-4 text-sm text-secondary">${detailsHtml}</td>`;
                    historyTableBody.appendChild(row);
                });
            }

            // Vozduh History
            function initializeVozduhHistoryView() {
                historyTitle.textContent = "–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –ö–∞—á–µ—Å—Ç–≤–æ –≤–æ–∑–¥—É—Ö–∞";
                const q = query(vozduhHistoryRef, orderBy('timestamp', 'desc'));
                unsubscribeVozduhHistory = onSnapshot(q, (snapshot) => {
                    renderVozduhHistory(snapshot.docs.map(doc => doc.data()));
                });
            }
             async function logVozduhHistory(action, docId, details) {
                const logData = { ...details };
                if (logData.oldData?.datetime?.toDate) logData.oldData.datetime = logData.oldData.datetime.toDate().toISOString();
                if (logData.newData?.datetime?.toDate) logData.newData.datetime = logData.newData.datetime.toDate().toISOString();
                if (logData.deletedData?.datetime?.toDate) logData.deletedData.datetime = logData.deletedData.datetime.toDate().toISOString();
                try {
                    await addDoc(vozduhHistoryRef, { action, docId, details: logData, userEmail: currentUserEmail, timestamp: serverTimestamp() });
                } catch(error) { console.error("Failed to log Vozduh history:", error); }
            }
            function renderVozduhHistory(historyData) {
                historyTableBody.innerHTML = '';
                if (historyData.length === 0) {
                    historyTableBody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-secondary">–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—É—Å—Ç–∞.</td></tr>';
                    return;
                }
                historyData.forEach(log => {
                    const row = document.createElement('tr');
                    const date = log.timestamp?.toDate ? log.timestamp.toDate().toLocaleString('ru-RU') : 'N/A';
                    let detailsHtml = '';
                    if (log.action === 'create' && log.details?.newData) {
                        detailsHtml = `–°–æ–∑–¥–∞–Ω–∞ –∑–∞–ø–∏—Å—å. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: "${log.details.newData.comment || ''}"`;
                    } else if (log.action === 'delete' && log.details?.deletedData) {
                        detailsHtml = `–£–¥–∞–ª–µ–Ω–∞ –∑–∞–ø–∏—Å—å. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –±—ã–ª: "${log.details.deletedData.comment || ''}"`;
                    } else if (log.action === 'update' && log.details?.newData && log.details?.oldData) {
                         const changes = Object.keys(log.details.newData).reduce((acc, key) => {
                            const oldValue = log.details.oldData[key] ?? '–ø—É—Å—Ç–æ';
                            const newValue = log.details.newData[key] ?? '–ø—É—Å—Ç–æ';
                             
                            const oldValStr = oldValue?.toDate ? oldValue.toDate().toISOString() : String(oldValue);
                            const newValStr = newValue?.toDate ? newValue.toDate().toISOString() : String(newValue);

                            if (oldValStr !== newValStr) {
                                acc.push(`<b>${key}</b>: "${oldValStr}" -> "${newValStr}"`);
                            }
                            return acc;
                        }, []);
                        detailsHtml = changes.length > 0 ? `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${changes.join('<br>')}` : '–ó–∞–ø–∏—Å—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π).';
                    } else {
                        detailsHtml = `–î–µ–π—Å—Ç–≤–∏–µ "${log.action}" (–Ω–µ—Ç –¥–µ—Ç–∞–ª–µ–π)`;
                    }

                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-secondary">${log.userEmail}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-secondary">${log.action}</td>
                        <td class="px-6 py-4 text-sm text-secondary">${detailsHtml}</td>`;
                    historyTableBody.appendChild(row);
                });
            }


            // --- Helpers ---
            function getNumericValue(elementId) {
                const value = parseFloat(document.getElementById(elementId).value);
                return isNaN(value) ? null : value;
            }

            function setDefaultDateTimes() {
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                const dateValue = now.toISOString().slice(0,10);
                const timeValue = now.toISOString().slice(11,16);

                document.getElementById('klimat-date').value = dateValue;
                document.getElementById('klimat-time').value = timeValue;

                document.getElementById('vozduh-date').value = dateValue;
                document.getElementById('vozduh-time').value = timeValue;
            }

            function handleVozduhSearch() {
                const searchDateVal = document.getElementById('vozduh-search-date').value;
                if (!searchDateVal) {
                    renderVozduhTable(allVozduhRecords);
                    return;
                }
                const filteredData = allVozduhRecords.filter(record => record.date === searchDateVal);
                renderVozduhTable(filteredData);
            }

            function resetVozduhSearch() {
                document.getElementById('vozduh-search-date').value = '';
                renderVozduhTable(allVozduhRecords);
            }
        });
    </script>
</body>
</html>
